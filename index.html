<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESPP Calculator</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
      margin-right: 12px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e0;
      transition: 0.3s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: #3182ce;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    .toggle-slider:hover {
      background-color: #a0aec0;
    }

    input:checked + .toggle-slider:hover {
      background-color: #2c5282;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
        Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
      padding: 40px 20px;
    }

    .calculator {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07),
        0 10px 25px rgba(0, 0, 0, 0.05);
      padding: 40px;
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
    }

    .calculator-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      align-items: start;
    }

    .inputs-section {
      min-width: 0;
    }

    .results-section {
      min-width: 0;
      position: sticky;
      top: 20px;
    }

    h1 {
      color: #1a202c;
      margin-bottom: 8px;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .subtitle {
      color: #718096;
      margin-bottom: 35px;
      font-size: 15px;
      font-weight: 500;
    }

    .section-title {
      color: #2d3748;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e2e8f0;
    }

    .input-group {
      margin-bottom: 24px;
    }

    .label-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .tooltip-icon {
      width: 16px;
      height: 16px;
      background: #4299e1;
      color: white;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      cursor: help;
      position: relative;
    }

    .tooltip-icon:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    .tooltip-text {
      visibility: hidden;
      opacity: 0;
      background: #2d3748;
      color: white;
      text-align: left;
      border-radius: 6px;
      padding: 12px;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      width: 250px;
      font-size: 12px;
      line-height: 1.5;
      font-weight: 400;
      transition: opacity 0.3s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .tooltip-text::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #2d3748 transparent transparent transparent;
    }

    label {
      color: #4a5568;
      font-weight: 700;
      font-size: 14px;
      margin: 0;
      /* Change from 'margin-bottom: 8px;' to 'margin: 0;' */
    }

    input,
    select {
      width: 100%;
      padding: 12px 16px;
      border: 1.5px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.2s;
      background: white;
      color: #2d3748;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    input.error,
    .custom-select-trigger.error {
      border-color: #f56565;
      box-shadow: 0 0 0 3px rgba(245, 101, 101, 0.1);
    }

    input::placeholder {
      color: #a0aec0;
    }

    .custom-select {
      position: relative;
      width: 100%;
    }

    .custom-select-trigger {
      width: 100%;
      padding: 12px 16px;
      border: 1.5px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      background: white;
      color: #2d3748;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .custom-select-trigger:hover {
      border-color: #cbd5e0;
    }

    .custom-select-trigger.active {
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .custom-select-trigger.placeholder {
      color: #a0aec0;
    }

    .custom-select-arrow {
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 5px solid #4a5568;
      transition: transform 0.2s;
    }

    .custom-select-trigger.active .custom-select-arrow {
      transform: rotate(180deg);
    }

    .custom-select-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: white;
      border: 1.5px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07),
        0 10px 25px rgba(0, 0, 0, 0.05);
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: all 0.2s;
      z-index: 1000;
    }

    .custom-select-dropdown.active {
      max-height: 250px;
      overflow-y: auto;
      opacity: 1;
    }

    .custom-select-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s;
      font-size: 15px;
      color: #2d3748;
    }

    .custom-select-option:hover {
      background: #f7fafc;
    }

    .custom-select-option.selected {
      background: #ebf8ff;
      color: #2c5282;
      font-weight: 500;
    }

    .custom-select-dropdown::-webkit-scrollbar {
      width: 8px;
    }

    .custom-select-dropdown::-webkit-scrollbar-track {
      background: #f7fafc;
      border-radius: 8px;
    }

    .custom-select-dropdown::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 8px;
    }

    .custom-select-dropdown::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }

    .price-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    button {
      width: 100%;
      padding: 16px;
      background: #3182ce;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(49, 130, 206, 0.2);
    }

    button:hover {
      background: #2c5282;
      box-shadow: 0 4px 8px rgba(49, 130, 206, 0.3);
    }

    button:active {
      transform: translateY(1px);
    }

    .results {
      display: block;
    }

    .results-header {
      color: #2d3748;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e2e8f0;
    }

    .result-item {
      padding: 16px 0;
      border-bottom: 1px solid #f7fafc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-label {
      color: #718096;
      font-size: 14px;
      font-weight: 700;
    }

    .result-value {
      color: #2d3748;
      font-weight: 600;
      font-size: 16px;
    }

    .highlight {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .highlight .result-item {
      border-bottom-color: rgba(255, 255, 255, 0.1);
      padding: 12px 0;
    }

    .highlight .result-label,
    .highlight .result-value {
      color: white;
    }

    .highlight .result-label {
      opacity: 0.9;
    }

    .collapsible-header {
      background: #fffaf0;
      border-left: 4px solid #ed8936;
      padding: 20px;
      border-radius: 8px;
      margin-top: 30px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .collapsible-header:hover {
      background: #fef5e7;
    }

    .collapsible-header strong {
      color: #7c2d12;
      font-size: 14px;
      font-weight: 600;
    }

    .collapsible-arrow {
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid #7c2d12;
      transition: transform 0.2s;
    }

    .collapsible-arrow.open {
      transform: rotate(180deg);
    }

    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      background: #fffaf0;
      border-left: 4px solid #ed8936;
      border-radius: 0 0 8px 8px;
      margin-top: -8px;
    }

    .collapsible-content.open {
      max-height: 1000px;
      transition: max-height 0.5s ease-in;
    }

    .collapsible-content-inner {
      padding: 0 20px 20px 20px;
      font-size: 13.5px;
      color: #744210;
      line-height: 1.7;
    }

    .collapsible-content-inner strong {
      color: #7c2d12;
      display: block;
      margin-top: 12px;
      margin-bottom: 6px;
    }

    .collapsible-content-inner strong:first-child {
      margin-top: 0;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 600px) {
      .price-inputs {
        grid-template-columns: 1fr;
      }

      .calculator {
        padding: 30px 20px;
      }
    }

    @media (max-width: 600px) {
      .price-inputs {
        grid-template-columns: 1fr;
      }

      .calculator {
        padding: 30px 20px;
      }
    }

    @media (max-width: 1024px) {
      .calculator-content {
        grid-template-columns: 1fr;
        gap: 30px;
      }

      .results-section {
        position: static;
      }
    }
  </style>
</head>

<body>
  <div class="calculator">
    <h1>ESPP Calculator</h1>

    <div class="calculator-content">
      <div class="inputs-section">
        <div class="input-group">
          <div class="label-wrapper">
            <label for="offeringPeriod">Select Offering Period</label>
            <span class="tooltip-icon">i
              <span class="tooltip-text">Choose your ESPP offering period. Each period is 6 months
                long.</span>
            </span>
          </div>
          <div class="custom-select" id="periodSelect">
            <div class="custom-select-trigger">
              <span id="selectedPeriod">October to March</span>
              <div class="custom-select-arrow"></div>
            </div>
            <div class="custom-select-dropdown">
              <div class="custom-select-option selected" data-value="oct-mar">
                October to March
              </div>
              <div class="custom-select-option" data-value="apr-sep">
                April to September
              </div>
            </div>
          </div>
          <input type="hidden" id="offeringPeriod" value="oct-mar" />
        </div>

        <div class="price-inputs">
          <div class="input-group">
            <div class="label-wrapper">
              <label for="priceA"><span id="startDateLabel">October 1</span> Stock Price</label>
              <span class="tooltip-icon">i
                <span class="tooltip-text">Enter the stock price at the beginning of the offering
                  period.</span>
              </span>
            </div>
            <input type="number" id="priceA" placeholder="USD $" step="0.01" min="0" />
          </div>

          <div class="input-group">
            <div class="label-wrapper">
              <label for="priceB"><span id="endDateLabel">March 31</span> Stock Price</label>
              <span class="tooltip-icon">i
                <span class="tooltip-text">Enter the stock price at the end of the offering
                  period.</span>
              </span>
            </div>
            <input type="number" id="priceB" placeholder="USD $" step="0.01" min="0" />
          </div>
        </div>

        <div class="input-group">
          <div class="label-wrapper">
            <label for="priceToday">Today's Stock Price (Optional)</label>
            <span class="tooltip-icon">i
              <span class="tooltip-text">Enter today's stock price to see what your shares would be
                worth today if you haven't sold them yet after the purchase
                date.</span>
            </span>
          </div>
          <input type="number" id="priceToday" placeholder="USD $ - Leave empty if not applicable" step="0.01"
            min="0" />
        </div>

        <div class="input-group">
          <div class="label-wrapper">
            <label class="toggle-label">
              <span class="toggle-switch">
                <input type="checkbox" id="useActualShares" />
                <span class="toggle-slider"></span>
              </span>
              I already received the shares
            </label>
            <span class="tooltip-icon">i
              <span class="tooltip-text">Enable this toggle if you already received your shares and know the exact number. When enabled, you'll enter the actual shares received, and the calculator will skip the salary and contribution fields. When disabled, the calculator will estimate shares based on your salary and contribution percentage.</span>
            </span>
          </div>
          <div class="label-wrapper" id="actualSharesLabel" style="display: none; margin-top: 12px;">
            <label for="actualShares">Actual Shares Received</label>
          </div>
          <input type="number" id="actualShares" placeholder="Enable the toggle above to activate" step="0.0001" min="0" disabled />
        </div>

        <div class="input-group" id="contributionGroup">
          <div class="label-wrapper">
            <label for="contribution">ESPP Contribution %</label>
            <span class="tooltip-icon">i
              <span class="tooltip-text">Select what percentage of your salary (1-20%) you want to
                contribute to ESPP each month.</span>
            </span>
          </div>
          <div class="custom-select" id="customSelect">
            <div class="custom-select-trigger placeholder">
              <span id="selectedValue">Select percentage</span>
              <div class="custom-select-arrow"></div>
            </div>
            <div class="custom-select-dropdown">
              <div class="custom-select-option" data-value="">
                Select percentage
              </div>
              <div class="custom-select-option" data-value="1">1%</div>
              <div class="custom-select-option" data-value="2">2%</div>
              <div class="custom-select-option" data-value="3">3%</div>
              <div class="custom-select-option" data-value="4">4%</div>
              <div class="custom-select-option" data-value="5">5%</div>
              <div class="custom-select-option" data-value="6">6%</div>
              <div class="custom-select-option" data-value="7">7%</div>
              <div class="custom-select-option" data-value="8">8%</div>
              <div class="custom-select-option" data-value="9">9%</div>
              <div class="custom-select-option" data-value="10">10%</div>
              <div class="custom-select-option" data-value="11">11%</div>
              <div class="custom-select-option" data-value="12">12%</div>
              <div class="custom-select-option" data-value="13">13%</div>
              <div class="custom-select-option" data-value="14">14%</div>
              <div class="custom-select-option" data-value="15">15%</div>
              <div class="custom-select-option" data-value="16">16%</div>
              <div class="custom-select-option" data-value="17">17%</div>
              <div class="custom-select-option" data-value="18">18%</div>
              <div class="custom-select-option" data-value="19">19%</div>
              <div class="custom-select-option" data-value="20">20%</div>
            </div>
          </div>
          <input type="hidden" id="contribution" value="" />
        </div>

        <div class="input-group" id="salaryGroup">
          <div class="label-wrapper">
            <label for="salary">Monthly Base Salary (NIS)</label>
            <span class="tooltip-icon">i
              <span class="tooltip-text">Enter your gross monthly salary in NIS before taxes. This is
                used to calculate your ESPP contribution amount.</span>
            </span>
          </div>
          <input type="number" id="salary" placeholder="NIS ₪" step="1" min="0" />
        </div>

        <div class="input-group" id="exchangeRateGroup">
          <div class="label-wrapper">
            <label for="exchangeRate">NIS to USD Exchange Rate</label>
            <span class="tooltip-icon">i
              <span class="tooltip-text">Enter the current exchange rate from NIS to USD (e.g., 3.60
                means 1 USD = 3.60 NIS). Check current rates online.</span>
            </span>
          </div>
          <input type="number" id="exchangeRate" placeholder="e.g., 3.60" step="0.01" min="0" />
        </div>

        <button onclick="calculate()">Calculate</button>
      </div>

      <div class="results-section">
        <div class="results" id="results">
          <div class="results-header">Calculation Results</div>

          <div class="result-item">
            <span class="result-label">Lower Stock Price</span>
            <span class="result-value" id="lowerPrice">-</span>
          </div>

          <div class="result-item">
            <span class="result-label">Purchase Price - 15% Discount</span>
            <span class="result-value" id="purchasePrice">-</span>
          </div>

          <div class="result-item" id="monthlyContributionRow">
            <span class="result-label">Monthly Contribution (NIS)</span>
            <span class="result-value" id="monthlyContribution">-</span>
          </div>

          <div class="result-item" id="totalContributionNISRow">
            <span class="result-label">Total ESPP Contributions (6 months) - NIS</span>
            <span class="result-value" id="totalContributionNIS">-</span>
          </div>

          <div class="result-item">
            <span class="result-label">Total ESPP Contributions (6 months) - USD</span>
            <span class="result-value" id="totalContribution">-</span>
          </div>

          <div class="highlight">
            <div class="result-item">
              <span class="result-label">Number of Shares You'll Get</span>
              <span class="result-value" id="shares">-</span>
            </div>

            <div class="result-item">
              <span class="result-label">Their Value at <span id="endDateResult">March 31</span></span>
              <span class="result-value" id="marketValue">-</span>
            </div>

            <div class="result-item" id="todayValueRow" style="display: none">
              <span class="result-label">Their Value Today</span>
              <span class="result-value" id="marketValueToday">-</span>
            </div>

            <div class="result-item">
              <span class="result-label">Your Instant Profit at
                <span id="endDateProfit">March 31</span> (Value -
                Contribution)</span>
              <span class="result-value" id="profit">-</span>
            </div>

            <div class="result-item" id="todayProfitRow" style="display: none">
              <span class="result-label">Your Total Profit Today (Value Today - Contribution)</span>
              <span class="result-value" id="profitToday">-</span>
            </div>
          </div>

          <div class="collapsible-header" onclick="toggleFeesInfo()"
            style="border-left-color: #3182ce; background: #ebf8ff">
            <strong style="color: #2c5282">💰Important Information About Fees</strong>
            <div class="collapsible-arrow" id="feesArrow" style="border-top-color: #2c5282"></div>
          </div>
          <div class="collapsible-content" id="feesContent" style="border-left-color: #3182ce; background: #ebf8ff">
            <div class="collapsible-content-inner" style="color: #2c5282">
              <strong style="color: #2c5282">Purchase Fees (Covered by MSI):</strong>
              When you buy shares through the ESPP, E*TRADE charges a
              transaction fee. The good news: Motorola Solutions pays these
              purchase fees for you!<br /><br />
              <strong style="color: #2c5282">Selling Fees (Your Responsibility):</strong>
              When you sell your ESPP shares, E*TRADE will charge a selling
              fee. You are responsible for paying these fees. Make sure to
              factor this into your calculations when planning to sell.
            </div>
          </div>

          <div class="collapsible-header" onclick="toggleTaxInfo()">
            <strong>💡Understanding Your ESPP and Taxes</strong>
            <div class="collapsible-arrow" id="taxArrow"></div>
          </div>
          <div class="collapsible-content" id="taxContent">
            <div class="collapsible-content-inner">
              <strong>Important: This is "after-tax" money</strong>
              Your ESPP contribution is deducted from your salary after income
              tax has already been calculated and paid. For example, if your
              base salary is 25,000 NIS and you contribute 20%, you're
              contributing 5,000 NIS that you've already paid income tax on.
              This means the ESPP contribution comes from "after-tax" money.

              <strong>When you buy the shares (<span id="endDateTax">March 31</span>):</strong>
              No additional tax is owed at that moment. The shares just appear
              in your E*TRADE account.

              <strong>When you sell the shares (in the future):</strong>
              You'll only pay tax on the PROFIT you made (the difference
              between what you paid and what you sold them for). You won't be
              taxed again on the original contribution (the 5,000 NIS in our
              example) because you already paid tax on it when it was part of
              your salary.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const periodSelect = document.getElementById('periodSelect');
    const periodTrigger = periodSelect.querySelector(
      '.custom-select-trigger'
    );
    const periodDropdown = periodSelect.querySelector(
      '.custom-select-dropdown'
    );
    const periodOptions = periodSelect.querySelectorAll(
      '.custom-select-option'
    );
    const periodInput = document.getElementById('offeringPeriod');
    const selectedPeriodSpan = document.getElementById('selectedPeriod');
    const startDateLabel = document.getElementById('startDateLabel');
    const endDateLabel = document.getElementById('endDateLabel');

    periodTrigger.addEventListener('click', function (e) {
      e.stopPropagation();
      periodTrigger.classList.toggle('active');
      periodDropdown.classList.toggle('active');
    });

    periodOptions.forEach(option => {
      option.addEventListener('click', function () {
        const value = this.getAttribute('data-value');
        const text = this.textContent;

        periodInput.value = value;
        selectedPeriodSpan.textContent = text;

        if (value === 'oct-mar') {
          startDateLabel.textContent = 'October 1';
          endDateLabel.textContent = 'March 31';
          document.getElementById('endDateResult').textContent = 'March 31';
          document.getElementById('endDateProfit').textContent = 'March 31';
          document.getElementById('endDateTax').textContent = 'March 31';
        } else {
          startDateLabel.textContent = 'April 1';
          endDateLabel.textContent = 'September 30';
          document.getElementById('endDateResult').textContent =
            'September 30';
          document.getElementById('endDateProfit').textContent =
            'September 30';
          document.getElementById('endDateTax').textContent = 'September 30';
        }

        periodOptions.forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');

        periodTrigger.classList.remove('active');
        periodDropdown.classList.remove('active');
      });
    });

    document.addEventListener('click', function (e) {
      if (!periodSelect.contains(e.target)) {
        periodTrigger.classList.remove('active');
        periodDropdown.classList.remove('active');
      }
    });

    const customSelect = document.getElementById('customSelect');
    const trigger = customSelect.querySelector('.custom-select-trigger');
    const dropdown = customSelect.querySelector('.custom-select-dropdown');
    const options = customSelect.querySelectorAll('.custom-select-option');
    const hiddenInput = document.getElementById('contribution');
    const selectedValueSpan = document.getElementById('selectedValue');

    trigger.addEventListener('click', function (e) {
      e.stopPropagation();
      trigger.classList.toggle('active');
      dropdown.classList.toggle('active');
    });

    options.forEach(option => {
      option.addEventListener('click', function () {
        const value = this.getAttribute('data-value');
        const text = this.textContent;

        hiddenInput.value = value;
        selectedValueSpan.textContent = text;

        if (value !== '') {
          trigger.classList.remove('placeholder');
        } else {
          trigger.classList.add('placeholder');
        }

        options.forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');

        trigger.classList.remove('active');
        dropdown.classList.remove('active');
      });
    });

    document.addEventListener('click', function (e) {
      if (!customSelect.contains(e.target)) {
        trigger.classList.remove('active');
        dropdown.classList.remove('active');
      }
    });

    function formatNumber(num) {
      return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function calculate() {
      const priceA = parseFloat(document.getElementById('priceA').value);
      const priceB = parseFloat(document.getElementById('priceB').value);
      const priceToday = parseFloat(
        document.getElementById('priceToday').value
      );
      const contributionPercent = parseFloat(
        document.getElementById('contribution').value
      );
      const monthlySalary = parseInt(document.getElementById('salary').value);
      const exchangeRate = parseFloat(
        document.getElementById('exchangeRate').value
      );
      const useActualSharesCheckbox = document.getElementById('useActualShares').checked;
      const actualShares = parseFloat(document.getElementById('actualShares').value);

      // Clear previous errors
      document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

      let hasError = false;

      // Check each required field
      if (isNaN(priceA) || priceA <= 0) {
        document.getElementById('priceA').classList.add('error');
        hasError = true;
      }
      if (isNaN(priceB) || priceB <= 0) {
        document.getElementById('priceB').classList.add('error');
        hasError = true;
      }
      
      // Use checkbox to determine if we're using actual shares
      const useActualShares = useActualSharesCheckbox;
      
      if (!useActualShares) {
        // Normal mode: require contribution, salary, and exchange rate
        if (isNaN(contributionPercent) || contributionPercent < 1 || contributionPercent > 20) {
          trigger.classList.add('error');
          hasError = true;
        }
        if (isNaN(monthlySalary) || monthlySalary <= 0) {
          document.getElementById('salary').classList.add('error');
          hasError = true;
        }
        if (isNaN(exchangeRate) || exchangeRate <= 0) {
          document.getElementById('exchangeRate').classList.add('error');
          hasError = true;
        }
      } else {
        // Actual shares mode: require actual shares value
        if (isNaN(actualShares) || actualShares <= 0) {
          document.getElementById('actualShares').classList.add('error');
          hasError = true;
        }
      }

      if (hasError) {
        return;
      }

      const lowerPrice = Math.min(priceA, priceB);
      const purchasePrice = lowerPrice * 0.85;
      
      let numberOfShares, totalContribution, monthlyContribution, totalContributionNIS;
      
      if (useActualShares) {
        // Use actual shares and back-calculate contribution
        numberOfShares = actualShares;
        totalContribution = numberOfShares * purchasePrice;
        
        // If salary and exchange rate provided, calculate monthly contribution
        if (!isNaN(monthlySalary) && monthlySalary > 0 && !isNaN(exchangeRate) && exchangeRate > 0) {
          totalContributionNIS = totalContribution * exchangeRate;
          monthlyContribution = totalContributionNIS / 6;
        } else {
          monthlyContribution = null;
          totalContributionNIS = null;
        }
      } else {
        // Original calculation
        monthlyContribution = monthlySalary * (contributionPercent / 100);
        totalContributionNIS = monthlyContribution * 6;
        totalContribution = totalContributionNIS / exchangeRate;
        numberOfShares = totalContribution / purchasePrice;
      }
      
      const marketValue = numberOfShares * priceB;
      const profit = marketValue - totalContribution;

      document.getElementById('lowerPrice').textContent =
        '$' + lowerPrice.toFixed(2);
      document.getElementById('purchasePrice').textContent =
        '$' + purchasePrice.toFixed(2);
      
      if (monthlyContribution !== null) {
        document.getElementById('monthlyContribution').textContent =
          'ILS ' + monthlyContribution.toFixed(2);
      } else {
        document.getElementById('monthlyContribution').textContent = 'N/A';
      }
      
      if (totalContributionNIS !== null) {
        document.getElementById('totalContributionNIS').textContent =
          'ILS ' + totalContributionNIS.toFixed(2);
      } else {
        document.getElementById('totalContributionNIS').textContent = 'N/A';
      }
      
      document.getElementById('totalContribution').textContent =
        '$' + totalContribution.toFixed(2);
      document.getElementById('shares').textContent =
        numberOfShares.toFixed(4) + ' shares' + (useActualShares ? ' (actual)' : '');
      document.getElementById('marketValue').textContent =
        '$' + formatNumber(marketValue);
      const profitElement = document.getElementById('profit');
      profitElement.textContent =
        '$' +
        formatNumber(profit) +
        ' (' +
        ((profit / totalContribution) * 100).toFixed(1) +
        '%)';
      profitElement.style.color = profit >= 0 ? '#48bb78' : '#f56565';

      if (!isNaN(priceToday) && priceToday > 0) {
        const marketValueToday = numberOfShares * priceToday;
        const profitToday = marketValueToday - totalContribution;

        document.getElementById('marketValueToday').textContent =
          '$' + formatNumber(marketValueToday);

        const profitTodayElement = document.getElementById('profitToday');
        profitTodayElement.textContent =
          '$' +
          formatNumber(profitToday) +
          ' (' +
          ((profitToday / totalContribution) * 100).toFixed(1) +
          '%)';
        profitTodayElement.style.color = profitToday >= 0 ? '#48bb78' : '#f56565';

        document.getElementById('todayValueRow').style.display = 'flex';
        document.getElementById('todayProfitRow').style.display = 'flex';
      } else {
        document.getElementById('todayValueRow').style.display = 'none';
        document.getElementById('todayProfitRow').style.display = 'none';
      }
      
      // Hide/show NIS contribution fields based on toggle
      if (useActualShares) {
        document.getElementById('monthlyContributionRow').style.display = 'none';
        document.getElementById('totalContributionNISRow').style.display = 'none';
      } else {
        document.getElementById('monthlyContributionRow').style.display = 'flex';
        document.getElementById('totalContributionNISRow').style.display = 'flex';
      }
    }

    function toggleTaxInfo() {
      const content = document.getElementById('taxContent');
      const arrow = document.getElementById('taxArrow');

      content.classList.toggle('open');
      arrow.classList.toggle('open');
    }

    function toggleFeesInfo() {
      const content = document.getElementById('feesContent');
      const arrow = document.getElementById('feesArrow');

      content.classList.toggle('open');
      arrow.classList.toggle('open');
    }

    document.querySelectorAll('input').forEach(input => {
      input.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          calculate();
        }
      });

      // Remove error styling when user starts typing
      input.addEventListener('input', function () {
        this.classList.remove('error');
      });
    });

    // Handle checkbox to show/hide fields and enable/disable inputs
    document.getElementById('useActualShares').addEventListener('change', function() {
      const isChecked = this.checked;
      const actualSharesInput = document.getElementById('actualShares');
      const actualSharesLabel = document.getElementById('actualSharesLabel');
      const contributionGroup = document.getElementById('contributionGroup');
      const salaryGroup = document.getElementById('salaryGroup');
      const exchangeRateGroup = document.getElementById('exchangeRateGroup');
      const priceTodayInput = document.getElementById('priceToday');
      
      if (isChecked) {
        // Show label and enable actual shares input
        actualSharesLabel.style.display = 'flex';
        actualSharesInput.disabled = false;
        actualSharesInput.placeholder = 'Enter actual shares received';
        
        // Hide contribution, salary, and exchange rate fields
        contributionGroup.classList.add('hidden');
        salaryGroup.classList.add('hidden');
        exchangeRateGroup.classList.add('hidden');
        
        // Keep Today's Stock Price enabled
        priceTodayInput.disabled = false;
        priceTodayInput.placeholder = 'USD $ - Leave empty if not applicable';
      } else {
        // Hide label and disable actual shares input
        actualSharesLabel.style.display = 'none';
        actualSharesInput.disabled = true;
        actualSharesInput.placeholder = 'Enable the toggle above to activate';
        actualSharesInput.value = '';
        actualSharesInput.classList.remove('error');
        
        // Show contribution, salary, and exchange rate fields
        contributionGroup.classList.remove('hidden');
        salaryGroup.classList.remove('hidden');
        exchangeRateGroup.classList.remove('hidden');
        
        // Keep Today's Stock Price enabled
        priceTodayInput.disabled = false;
        priceTodayInput.placeholder = 'USD $ - Leave empty if not applicable';
      }
    });

    // Remove error styling from contribution select when changed
    options.forEach(option => {
      option.addEventListener('click', function () {
        trigger.classList.remove('error');
      });
    });

    // Remove error styling from period select when changed
    periodOptions.forEach(option => {
      option.addEventListener('click', function () {
        periodTrigger.classList.remove('error');
      });
    });
  </script>
</body>

</html>